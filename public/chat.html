<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bubu Chat - Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    #chatBox {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
    }

    .Bubu {
      color: #FF69B4; /* Pink */
    }

    .Dudu {
      color: #1E90FF; /* Blue */
    }
  </style>
</head>
<body>
  <h1>Bubu Chat Room</h1>
  <div id="chatBox"></div>
  <input type="text" id="messageInput" maxlength="200" placeholder="Type your message...">
  <button id="sendButton" class="button">Send</button>
  <p id="limitMessage" style="color: red; display: none;"></p>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role');
    
    // Redirect if no role or invalid role
    if (!role || !['Bubu', 'Dudu'].includes(role)) {
      window.location.href = '/home';
    }
    
    const otherRole = role === 'Bubu' ? 'Dudu' : 'Bubu';
    const chatCode = window.location.pathname.split('/').pop();

    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const limitMessage = document.getElementById('limitMessage');

    // Load messages from the server and display them in the chat box
    async function loadMessages() {
      const response = await fetch(`/chat/${chatCode}/messages`);
      if (response.ok) {
        const data = await response.json();
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = data.messages.map(msg => 
          `<p><strong class="${msg.user}">${msg.user}:</strong> ${msg.message}</p>`
        ).join('');
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    // Send message to the server
    async function sendMessage() {
      const message = messageInput.value;
      if (message.trim() !== '') {
        const response = await fetch(`/chat/${chatCode}/send-message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: role, message })
        });

        if (response.status === 403) {
          // Message limit reached
          disableChat();
        } else {
          messageInput.value = '';
          loadMessages();  // Update the chat box after sending a message
        }
      }
    }

    // Disable input and show limit message
    function disableChat() {
      messageInput.disabled = true;
      sendButton.disabled = true;
      limitMessage.style.display = 'block';
      limitMessage.textContent = `Enough for the day, ${otherRole} can't take it anymore!`;
    }

    // Check for Enter key press to send message
    messageInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    });

    // Send button click event
    sendButton.addEventListener('click', sendMessage);

    // Load messages initially and every 2 seconds
    loadMessages();
    setInterval(loadMessages, 2000);  // Periodically load new messages to keep the chat updated
  </script>
</body>
</html>
